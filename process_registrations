#!/usr/bin/env python3

import cgi
import cgitb
import sqlite3

import process_form
from reg_request_db import RegDb

debugdir = '/tmp'
datadir  = '/var/spool/registration'
dbfile   = '{}/account_queue.db'.format(datadir)

cgitb.enable(display=0, logdir=debugdir)
the_form = cgi.FieldStorage()

print('Content-type: text/html\n')

if "email" not in the_form:
    print(process_form.full_form)

else:
    try:
        reg_db = RegDb(dbfile)

    except ConnectionError as ce:
        print('''{start}

<h1>Internal Error</h1>

<p>The registration system is currently unavailable.  Please try back later.</p>

<p>Exception:</br>
{the_error}
</p>

{end}'''.format(start     = process_form.header,
                end       = process_form.footer,
                the_error = ce)
        )

    else:
        # TODO: Rework for processing registrations...
        print(process_form.header)

        if "addr2" in the_form:
            reg_db.insert(the_form["first"].value, the_form["last"].value,
                the_form["email"].value, the_form["addr1"].value, the_form["city"].value,
                the_form["state"].value, the_form["zipcode"].value, the_form["username"].value,
                the_form["addr2"].value)
        else:
            reg_db.insert(the_form["first"].value, the_form["last"].value,
                the_form["email"].value, the_form["addr1"].value, the_form["city"].value,
                the_form["state"].value, the_form["zipcode"].value, the_form["username"].value)

        reg_db.print_queue()
        print(process_form.footer)
